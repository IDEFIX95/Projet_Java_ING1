package com.projet.projet_java;

import org.junit.platform.engine.discovery.DiscoverySelectors;
import org.junit.platform.launcher.*;
import org.junit.platform.launcher.core.*;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

public class MainTest {

    public static void main(String[] args) {
        // üîÅ Forcer la base de donn√©es de test
        DatabaseConfig.setUseTestDatabase(true);

        // 1Ô∏è‚É£ Lancer les tests JUnit du package
        System.out.println("üöÄ Lancement des tests JUnit :");

        // ‚úÖ R√©initialiser la base de test avant d‚Äôex√©cuter les tests
        //SQLExecutor.runScript("Database/tri_selectifTest.sql");

        LauncherDiscoveryRequest request = LauncherDiscoveryRequestBuilder.request()
                .selectors(DiscoverySelectors.selectPackage("com.projet.projet_java"))
                .build();

        Launcher launcher = LauncherFactory.create();
        launcher.execute(request);

        // 2Ô∏è‚É£ Afficher les donn√©es des tables apr√®s les tests
        System.out.println("\nüìä Affichage du contenu des tables dans tri_selectifTest :");

        try (Connection conn = DatabaseConnection.getConnection()) {
            if (conn == null) {
                System.out.println("‚ùå Connexion √©chou√©e √† la base de donn√©es.");
                return;
            }

            System.out.println("‚úÖ Connexion √† la base MySQL [tri_selectifTest] r√©ussie !");
            String[] tables = {
                    "Dechet", "Menage", "PoubelleIntelligente", "HistoriqueDepot",
                    "Corbeille", "Commerce", "ContratPartenariat", "CentreDeTri",
                    "Categorie", "BonAchat"
            };

            for (String table : tables) {
                System.out.println("\nüìÇ Table : " + table);
                afficherContenuTable(conn, table);
            }

        } catch (SQLException e) {
            System.out.println("‚ùå Erreur SQL globale : " + e.getMessage());
        }
    }

    private static void afficherContenuTable(Connection conn, String tableName) {
        String query = "SELECT * FROM " + tableName;
        try (PreparedStatement stmt = conn.prepareStatement(query);
             ResultSet rs = stmt.executeQuery()) {

            int columnCount = rs.getMetaData().getColumnCount();

            if (!rs.isBeforeFirst()) {
                System.out.println("   (aucune donn√©e)");
                return;
            }

            while (rs.next()) {
                StringBuilder row = new StringBuilder("   ‚û§ ");
                for (int i = 1; i <= columnCount; i++) {
                    String column = rs.getMetaData().getColumnLabel(i);
                    String value = rs.getString(i);
                    row.append(column).append("=").append(value).append("  ");
                }
                System.out.println(row);
            }

        } catch (SQLException e) {
            System.out.println("   ‚ö†Ô∏è Erreur lors de l'acc√®s √† la table '" + tableName + "' : " + e.getMessage());
        }
    }
}
